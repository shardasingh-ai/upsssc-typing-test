<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UPSSSC Junior Assistant Typing Test (EN ➜ HI)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&display=swap');

  :root{
    --bg:#f3f5f7; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
    --accent:#22c55e; --accent-700:#16a34a; --danger:#ef4444; --warning:#f59e0b;
    --ring:0 1px 2px rgba(0,0,0,.04), 0 4px 16px rgba(2,6,23,.10);
    --soft:0 1px 2px rgba(2,6,23,.05); --radius:14px;
    --ok-grey:#e5e7eb;     /* correct -> light grey */
    --cur-yellow:#fef08a;  /* current -> yellow */
    --err-red:#fecaca;     /* wrong -> red */
  }
  *{box-sizing:border-box}
  body{margin:0; font:14px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; color:var(--text); background:var(--bg)}
  .page{max-width:980px; margin:28px auto; padding:0 16px}

  .hero{background:linear-gradient(135deg,var(--accent) 0%, var(--accent-700) 60%); color:#fff; border-radius:18px; box-shadow:var(--ring); padding:18px 20px 14px}
  .hero h1{margin:0; font-weight:800}
  .hero small{font-weight:700; opacity:.95}
  .badges{display:flex; gap:14px; margin-top:8px; flex-wrap:wrap}
  .badge{display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,.12); padding:6px 10px; border-radius:999px; font-weight:700}
  .dot{width:6px; height:6px; background:#60a5fa; border-radius:50%}

  .controls{display:flex; align-items:center; gap:12px; margin-top:14px; flex-wrap:wrap}
  .right{margin-left:auto; display:flex; align-items:center; gap:10px}
  .btn{background:#fff; color:#0b1220; border:1px solid rgba(15,23,42,.08); padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  .btn:hover{background:#f8fafc}
  #timerEl{background:#fff; color:#0b1220; font-weight:800; padding:10px 14px; border-radius:12px; box-shadow:var(--soft); min-width:84px; text-align:center}

  .section{background:var(--card); border-radius:var(--radius); box-shadow:var(--ring); padding:18px; margin-top:18px}
  .section h3{margin:0 0 10px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.14em}
  .scroll{max-height:210px; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; padding:16px; background:#fff}
  .inputbox{min-height:160px; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; padding:16px; background:#f8fafc}

  /* Highlights per rules */
  #textDisplay span.ok{background:var(--ok-grey); color:#111827; padding:2px 3px; border-radius:4px}
  #textDisplay span.err{background:var(--err-red); color:#7f1d1d; text-decoration:underline; text-decoration-color:#b91c1c; padding:2px 3px; border-radius:4px}
  #textDisplay span.cur{background:var(--cur-yellow); color:#111827; padding:2px 3px; border-radius:4px}

  .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px}
  .stat{border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; background:#fff}
  .stat small{display:block; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.12em}
  .value{font-size:20px; font-weight:800; margin-top:6px}
  .value .u{font-size:11px; color:var(--muted); font-weight:700; margin-left:4px}
  .final{margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap}
  .pill-fail{background:#fee2e2; color:#991b1b; border:1px solid #fecaca; font-weight:900; letter-spacing:.08em; padding:10px 18px; border-radius:12px}
  .pill-pass{background:#dcfce7; color:#065f46; border:1px solid #bbf7d0; font-weight:900; letter-spacing:.08em; padding:10px 18px; border-radius:12px}
  .note{color:var(--muted)}
  .hidden{display:none}

  .rows{display:grid; gap:12px}
  .row{display:grid; grid-template-columns:140px 1fr; gap:12px; align-items:center}
  .kbd{background:#111827; color:#fff; padding:2px 8px; border-radius:6px; font-size:12px}

  /* Toast under header (centered) */
  #toastWrap{ display:none; margin-top:12px; }
  #toast{
    margin:0 auto; max-width:820px; padding:12px 16px; border-radius:10px;
    background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca;
    font-weight:800; text-align:center; box-shadow:var(--ring);
    opacity:0; transition:opacity .25s ease;
  }
  #toastWrap.show{ display:block; }
  #toastWrap.show #toast{ opacity:1; }

  @media (max-width:820px){.grid{grid-template-columns:1fr}}
#instructions{display:none!important}
</style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <h1>UPSSSC <small>Junior Assistant Typing Test</small></h1>
      <div class="badges">
        <span class="badge"><span class="dot"></span> English: <strong>30 WPM</strong></span>
        <span class="badge"><span class="dot"></span> Hindi: <strong>25 WPM</strong></span>
        <span class="badge"><span class="dot"></span> Duration: <strong>5 + 5 Minutes</strong></span>
        
      </div>

      <div class="controls">
        <div class="left">
          <span id="stageLabel" style="font-weight:800">Stage: <u>English</u> → Hindi</span>
          <label id="passageLabel" style="color:#eaf7ee; font-weight:700; margin-left:12px;">Passage:</label>
          <select id="passageSet" style="margin-right:8px;"></select>
          <label id="fontLabel" class="hidden" style="color:#eaf7ee; font-weight:700; margin-left:12px;">Hindi Font:</label>
          <select id="hindiFont" class="hidden">
            <option value="Noto Sans Devanagari" selected>Noto Sans Devanagari (Default)</option>
            <option value="Mangal">Mangal (Inscript)</option>
            <option value="Kruti Dev 010">Kruti Dev 010 (requires system font)</option>
          </select>
        </div>
        <div class="right">
          <button id="startBtn" class="btn" disabled>Loading…</button>
          <span id="timerEl">5:00</span>
          <button id="submitBtn" class="btn hidden">Submit</button>
          <button id="resetBtn" class="btn">Reset</button>
        </div>
      </div>
    </header>

    <!-- Toast area (under header) -->
    <div id="toastWrap"><div id="toast">⚠️ CTRL/CMD or Paste not allowed</div></div>

    <!-- RULES (visible before start, hidden during the test) -->
    <section class="section" id="instructions">
      <h3>Evaluation Rules</h3>
      <div class="rows">
        <div class="row"><div class="kbd">1</div><div><b>Net Speed</b>: English 30 WPM, Hindi 25 WPM. <b>5 keystrokes = 1 word</b>.</div></div>
        <div class="row"><div class="kbd">2</div><div>English target = 150 words (750 keystrokes), Hindi = 125 words (625 keystrokes) in <b>5 minutes</b>. <i>Space counts as one keystroke.</i></div></div>
        <div class="row"><div class="kbd">3</div><div><b>Highlights:</b> current = <span style="background:var(--cur-yellow); padding:2px 6px; border-radius:6px">yellow</span>, correct = <span style="background:var(--ok-grey); padding:2px 6px; border-radius:6px">light grey</span>, wrong = <span style="background:var(--err-red); padding:2px 6px; border-radius:6px">red</span>.</div></div>
        <div class="row"><div class="kbd">4</div><div><b>Backspace</b>: only current & previous word (edit allowed only within the last <b>2 spaces</b> of what you typed).</div></div>
        <div class="row"><div class="kbd">5</div><div><b>Ctrl/Cmd</b> not allowed (blocks copy/paste/refresh).</div></div>
        <div class="row"><div class="kbd">6</div><div>Auto-scroll enabled. Refresh/reload blocked during test.</div></div>
        <div class="row"><div class="kbd">7</div><div>Errors: first <b>5 free</b>, then <b>−5 correct words</b> per extra mistake. <i>Full</i> = incorrect/omitted word; <i>Partial</i> = order/spacing/case/punctuation.</div></div>
        <div class="row"><div class="kbd">8</div><div>Hindi font: <b>Noto Sans Devanagari</b> (default) or system fonts like <b>Mangal</b>/<b>Kruti Dev 010</b>.</div></div>
      </div>
    </section>

    <!-- REFERENCE TEXT -->
    <section class="section">
      <h3>Reference Text</h3>
      <div id="textDisplay" class="scroll">Click "Start English" to begin</div>
    </section>

    <!-- TYPING AREA -->
    <section class="section">
      <h3>Your Typing Area</h3>
      <div class="inputbox" id="inputWrapper">
        <textarea id="inputArea" placeholder="Start typing here..." disabled
          autocorrect="off" autocomplete="off" autocapitalize="off" spellcheck="false"
          style="width:100%; height:140px; border:none; outline:none; background:transparent; font-size:14px; line-height:1.6;"></textarea>
      </div>
      <small class="note">Type exactly. Backspace: current & previous word only (allowed within last two spaces of your text).</small>
    </section>

    <!-- RESULTS -->
    <section class="section">
      <h3>Test Results</h3>
      <div id="bothResults" class="hidden">
        <div class="grid">
          <div class="stat"><small>EN Gross</small><div id="grossEN" class="value">0.00<span class="u"> WPM</span></div></div>
          <div class="stat"><small>EN Net</small><div id="netEN" class="value">0.00<span class="u"> WPM</span></div></div>
          <div class="stat"><small>HI Gross</small><div id="grossHI" class="value">0.00<span class="u"> WPM</span></div></div>
          <div class="stat"><small>HI Net</small><div id="netHI" class="value">0.00<span class="u"> WPM</span></div></div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div class="stat"><small>EN Errors</small><div class="value"><span id="fullEN">0</span> full, <span id="partialEN">0</span> partial</div></div>
          <div class="stat"><small>EN Penalty</small><div id="penaltyEN" class="value" style="color:var(--warning)">0<span class="u"> Words</span></div></div>
          <div class="stat"><small>HI Errors</small><div class="value"><span id="fullHI">0</span> full, <span id="partialHI">0</span> partial</div></div>
          <div class="stat"><small>HI Penalty</small><div id="penaltyHI" class="value" style="color:var(--warning)">0<span class="u"> Words</span></div></div>
        </div>
        <div class="final">
          <div id="badgeEN" class="pill-fail">EN: FAIL</div>
          <div id="badgeHI" class="pill-fail">HI: FAIL</div>
          <div id="badgeOverall" class="pill-fail">OVERALL: FAIL</div>
          <span class="note">Both languages must meet minimum net WPM.</span>
        </div>
      </div>
      <div id="preResultsNote" class="note">Results will appear after each stage and a combined summary at the end.</div>
    </section>
  </div>

  <script defer src="./passages.js?v=1"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    /* ===== Passages (loaded from external JSON) ===== */
    var englishPassage = "";
    var hindiPassage   = "";
    var passageSets = [];
    var selectedSetId = null;

    /* ===== Elements ===== */
    var els = {
      stageLabel: document.getElementById('stageLabel'),
      textDisplay: document.getElementById('textDisplay'),
      inputArea:  document.getElementById('inputArea'),
      startBtn:   document.getElementById('startBtn'),
      submitBtn:  document.getElementById('submitBtn'),
      resetBtn:   document.getElementById('resetBtn'),
      timerEl:    document.getElementById('timerEl'),
      bothResults:document.getElementById('bothResults'),
      preResultsNote: document.getElementById('preResultsNote'),
      grossEN:    document.getElementById('grossEN'),
      netEN:      document.getElementById('netEN'),
      penaltyEN:  document.getElementById('penaltyEN'),
      fullEN:     document.getElementById('fullEN'),
      partialEN:  document.getElementById('partialEN'),
      grossHI:    document.getElementById('grossHI'),
      netHI:      document.getElementById('netHI'),
      penaltyHI:  document.getElementById('penaltyHI'),
      fullHI:     document.getElementById('fullHI'),
      partialHI:  document.getElementById('partialHI'),
      badgeEN:    document.getElementById('badgeEN'),
      badgeHI:    document.getElementById('badgeHI'),
      badgeOverall: document.getElementById('badgeOverall'),
      hindiFont:  document.getElementById('hindiFont'),
      fontLabel:  document.getElementById('fontLabel'),
      passageSet: document.getElementById('passageSet'),
      passageLabel: document.getElementById('passageLabel'),
      toastWrap:  document.getElementById('toastWrap'),
      toast:      document.getElementById('toast'),
      instructions: document.getElementById('instructions')
    };

    /* ===== Toast ===== */
    var toastTimer = null;
    function showToast(msg){
      els.toast.textContent = msg;
      els.toastWrap.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(function(){ els.toastWrap.classList.remove('show'); }, 2000);
    }

    /* ===== State ===== */
    var intervalId = null;
    var timeLeft = 300;     // 5 minutes
    var started = false;
    var stage = 'EN';       // 'EN' -> 'HI'
    var passage = '';
    var startedAt = null;
    var results = { EN:null, HI:null };

    /* ===== Load passages from passages.json ===== */
    async function loadPassages(){
      // Read passages from a pre-loaded JS data file (no fetch for speed)
      var data = window.PASSAGES || {};
      var sets = [];
      if (Array.isArray(data.sets)){
        sets = data.sets.filter(function(s){ return s && s.english && s.hindi; });
      } else if (data.english && data.hindi){
        sets = [{ id: data.id || 'default', label: data.label || 'Default', english: data.english, hindi: data.hindi, difficulty: data.difficulty || 'medium' }];
      }

      if (!sets.length){
        // Built-in fallback (very small) if passages.js is missing
        sets = [{ id:'default', label:'Default (Built-in)',
          english:"The Uttar Pradesh Subordinate Services Selection Commission conducts the typing test to check a candidate's ability to type accurately at a practical pace. During the examination you will copy the given passage within a strict five minute window. The objective is not only to reach a higher speed, but also to maintain precision while switching between words, punctuation and casing. Students are advised to focus on rhythm, keep their posture neutral and avoid looking at the keyboard. With consistent practice the gross speed and net speed both improve substantially.",
          hindi:"उत्तर प्रदेश अधीनस्थ सेवा चयन आयोग द्वारा आयोजित टाइपिंग परीक्षा का उद्देश्य अभ्यर्थियों की गति के साथ-साथ शुद्धता का मूल्यांकन करना है। पाँच मिनट की समयावधि में दिए गए अनुच्छेद को हूबहू टाइप करना होता है। ध्यान रखें कि शब्द, विराम-चिह्न और बड़े-छोटे अक्षरों में त्रुटि न हो। स्थिर गति और लय के साथ अभ्यास करने से सकल गति तथा शुद्ध टाइपिंग गति में लगातार सुधार आता है। अभ्यर्थियों को सही कीबोर्ड लेआउट का प्रयोग करते हुए स्क्रीन पर ध्यान केंद्रित रखना चाहिए।",
          difficulty:'medium' }];
      }

      passageSets = sets.map(function(s,idx){ return Object.assign({ id: s.id || ('set-'+idx), label: s.label || ('Set '+(idx+1)) }, s); });
      els.passageSet.innerHTML = passageSets.map(function(s){ return '<option value="'+s.id+'">'+s.label+'</option>'; }).join('');
      els.passageSet.value = passageSets[0].id;
      applySet(passageSets[0].id);

      els.startBtn.disabled = false;
      els.startBtn.textContent = 'Start English';
    }];
      els.passageSet.innerHTML = '<option value="default">Default</option>';
      els.passageSet.value = 'default';
      applySet('default');
      els.startBtn.disabled = false;
      els.startBtn.textContent = 'Start English';

      // Now fetch external JSON (cached) and swap in when ready
      try{
        const res = await fetch('./passages.json?v=1'); // bump v when you update
        if(!res.ok) throw new Error('Failed to load passages.json');
        const data = await res.json();

        let sets = [];
        if (Array.isArray(data.sets)) {
          sets = data.sets.filter(s => s && s.english && s.hindi);
        } else if (data.english && data.hindi) {
          sets = [{ id:'default', label: data.label || 'Default', english: data.english, hindi: data.hindi, difficulty: data.difficulty || 'medium' }];
        }
        if (!sets.length) return; // keep instant default

        passageSets = sets.map((s, i) => Object.assign({ id: s.id || ('set-'+i), label: s.label || ('Set '+(i+1)) }, s));
        els.passageSet.innerHTML = passageSets.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
        els.passageSet.value = passageSets[0].id;
        applySet(passageSets[0].id);
      }catch(e){
        // Keep instant default silently
      }
    });
        if(!res.ok) throw new Error('Failed to load passages.json');
        const data = await res.json();

        if (Array.isArray(data.sets)){
          passageSets = data.sets.filter(function(s){ return s && s.english && s.hindi; });
        } else {
          passageSets = [{ id:'default', label:'Default (Medium)', english:(data.english||''), hindi:(data.hindi||''), difficulty:data.difficulty||'medium' }];
        }
        if (!passageSets.length) throw new Error('No passages found');

        // Normalize ids/labels and populate dropdown
        passageSets = passageSets.map(function(s,idx){ return Object.assign({ id: s.id || ('set-'+idx), label: s.label || ('Set '+(idx+1)) }, s); });
        els.passageSet.innerHTML = passageSets.map(function(s){ return '<option value="'+s.id+'">'+s.label+'</option>'; }).join('');
        els.passageSet.value = passageSets[0].id;
        applySet(passageSets[0].id);

        els.startBtn.disabled = false;
        els.startBtn.textContent = 'Start English';
      }catch(err){
        showToast('⚠️ Could not load passages. Using built-in defaults.');
        passageSets = [{ id:'default', label:'Default (Built-in)', english: "The Uttar Pradesh Subordinate Services Selection Commission conducts the typing test to check a candidate's ability to type accurately at a practical pace. During the examination you will copy the given passage within a strict five minute window. The objective is not only to reach a higher speed, but also to maintain precision while switching between words, punctuation and casing. Students are advised to focus on rhythm, keep their posture neutral and avoid looking at the keyboard. With consistent practice the gross speed and net speed both improve substantially.",
                         hindi: "उत्तर प्रदेश अधीनस्थ सेवा चयन आयोग द्वारा आयोजित टाइपिंग परीक्षा का उद्देश्य अभ्यर्थियों की गति के साथ-साथ शुद्धता का मूल्यांकन करना है। पाँच मिनट की समयावधि में दिए गए अनुच्छेद को हूबहू टाइप करना होता है। ध्यान रखें कि शब्द, विराम-चिह्न और बड़े-छोटे अक्षरों में त्रुटि न हो। स्थिर गति और लय के साथ अभ्यास करने से सकल गति तथा शुद्ध टाइपिंग गति में लगातार सुधार आता है। अभ्यर्थियों को सही कीबोर्ड लेआउट का प्रयोग करते हुए स्क्रीन पर ध्यान केंद्रित रखना चाहिए।",
                         difficulty:'medium' }];
        els.passageSet.innerHTML = '<option value="default">Default (Built-in)</option>';
        els.passageSet.value = 'default';
        applySet('default');
        els.startBtn.disabled = false;
        els.startBtn.textContent = 'Start English';
      }
    });
        if(!res.ok) throw new Error('Failed to load passages.json');
        const data = await res.json();
        englishPassage = (data.english || '').trim();
        hindiPassage   = (data.hindi   || '').trim();
        if(!englishPassage || !hindiPassage) throw new Error('Empty passages');
        els.startBtn.disabled = false;
        els.startBtn.textContent = 'Start English';
      }catch(err){
        // Fallback to built-in defaults if external load fails
        showToast('⚠️ Could not load passages. Using built-in defaults.');
        englishPassage = englishPassage || "The Uttar Pradesh Subordinate Services Selection Commission conducts the typing test to check a candidate's ability to type accurately at a practical pace. During the examination you will copy the given passage within a strict five minute window. The objective is not only to reach a higher speed, but also to maintain precision while switching between words, punctuation and casing. Students are advised to focus on rhythm, keep their posture neutral and avoid looking at the keyboard. With consistent practice the gross speed and net speed both improve substantially.";
        hindiPassage   = hindiPassage   || "उत्तर प्रदेश अधीनस्थ सेवा चयन आयोग द्वारा आयोजित टाइपिंग परीक्षा का उद्देश्य अभ्यर्थियों की गति के साथ-साथ शुद्धता का मूल्यांकन करना है। पाँच मिनट की समयावधि में दिए गए अनुच्छेद को हूबहू टाइप करना होता है। ध्यान रखें कि शब्द, विराम-चिह्न और बड़े-छोटे अक्षरों में त्रुटि न हो। स्थिर गति और लय के साथ अभ्यास करने से सकल गति तथा शुद्ध टाइपिंग गति में लगातार सुधार आता है। अभ्यर्थियों को सही कीबोर्ड लेआउट का प्रयोग करते हुए स्क्रीन पर ध्यान केंद्रित रखना चाहिए।";
        els.startBtn.disabled = false;
        els.startBtn.textContent = 'Start English';
      }
    }

    /* ===== Helpers ===== */
    function wordsOf(text){ return text && text.trim().length ? text.trim().split(/\s+/) : []; }
    function setPassage(text){
      var words = text.split(/\s+/);
      els.textDisplay.innerHTML = words.map(function(w,i){ return '<span data-i="'+i+'">'+w+'</span>'; }).join(' ');
    }
    function setFonts(){
      var chosen = els.hindiFont.value;
      if (stage === 'HI'){
        var f = (chosen || 'Noto Sans Devanagari') + ", Inter, system-ui";
        els.textDisplay.style.fontFamily = f;
        els.inputArea.style.fontFamily   = f;
      } else {
        els.textDisplay.style.fontFamily = 'Inter, system-ui';
        els.inputArea.style.fontFamily   = 'Inter, system-ui';
      }
    }
    function applySet(id){
      var set = (passageSets || []).find(function(s){ return s.id === id; }) || passageSets[0];
      if(!set){ return; }
      selectedSetId = set.id;
      englishPassage = (set.english||'').trim();
      hindiPassage   = (set.hindi||'').trim();
    } else {
        els.textDisplay.style.fontFamily = 'Inter, system-ui';
        els.inputArea.style.fontFamily   = 'Inter, system-ui';
      }
    }
    function renderTime(){
      var m = Math.floor(timeLeft/60), s = String(timeLeft%60).padStart(2,'0');
      els.timerEl.textContent = m + ":" + s;
    }
    function setButtonsRunning(running){
      els.startBtn.disabled = running;
      els.resetBtn.disabled = running;
      els.submitBtn.disabled = !running ? true : false;
      if (els.passageSet) els.passageSet.disabled = running;
    }
    function resetAll(){
      if (intervalId) { clearInterval(intervalId); intervalId=null; }
      timeLeft=300; started=false; stage='EN'; results.EN=results.HI=null;
      els.timerEl.textContent='5:00';
      els.textDisplay.textContent='Click "Start English" to begin';
      els.inputArea.value=''; els.inputArea.disabled=true; els.submitBtn.classList.add('hidden');
      els.bothResults.classList.add('hidden'); els.preResultsNote.classList.remove('hidden');
      els.startBtn.textContent='Start English';
      els.stageLabel.innerHTML='Stage: <u>English</u> → Hindi';
      els.fontLabel.classList.add('hidden'); els.hindiFont.classList.add('hidden');
      els.instructions.classList.remove('hidden');  // SHOW instructions before start
      setFonts(); setPassage('');
      setButtonsRunning(false);
    }

    /* ===== Flow ===== */
    function startStage(){
      if (started) return;
      started = true; timeLeft=300; startedAt=Date.now(); els.timerEl.textContent='5:00';
      els.instructions.classList.add('hidden');   // HIDE instructions after start
      els.inputArea.value=''; els.inputArea.disabled=false; els.inputArea.focus();
      els.submitBtn.classList.remove('hidden'); els.preResultsNote.classList.remove('hidden');
      setButtonsRunning(true);

      if (stage === 'EN'){
        passage = englishPassage;
        els.stageLabel.innerHTML='Stage: <b>English</b> → Hindi';
        els.startBtn.textContent='Running…';
        els.fontLabel.classList.add('hidden'); els.hindiFont.classList.add('hidden');
      } else {
        passage = hindiPassage;
        els.stageLabel.innerHTML='Stage: English → <b>Hindi</b>';
        els.startBtn.textContent='Running…';
        els.fontLabel.classList.remove('hidden'); els.hindiFont.classList.remove('hidden');
      }
      setPassage(passage); setFonts(); highlightProgress();

      renderTime();
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(function(){
        timeLeft--;
        renderTime();
        if (timeLeft <= 0){
          clearInterval(intervalId); intervalId=null;
          finishStage();
        }
      }, 1000);
    }

    function finishStage(){
      els.inputArea.disabled=true; els.submitBtn.classList.add('hidden');
      var stageResult = computeResults(); results[stage]=stageResult;
      setButtonsRunning(false);

      if (stage==='EN'){
        // 8s prep then auto-start Hindi
        var prep=8; els.textDisplay.innerHTML='Hindi starts in <b>'+prep+'</b> seconds… Select font above if needed.';
        var prepInt=setInterval(function(){
          prep--; els.textDisplay.innerHTML='Hindi starts in <b>'+prep+'</b> seconds… Select font above if needed.';
          if(prep<=0){ clearInterval(prepInt); stage='HI'; els.timerEl.textContent='5:00'; els.startBtn.textContent='Start Hindi'; startStage(); }
        },1000);
      } else {
        showCombinedResults(); els.startBtn.textContent='Restart';
      }
      started=false;
    }

    /* ===== Scoring & Highlights ===== */
    function computeResults(){
      var elapsedSec = Math.max(1, Math.round((Date.now()-startedAt)/1000));
      var minutes = elapsedSec/60;
      var refWords = passage.split(/\s+/);
      var typedRaw = els.inputArea.value;       // includes spaces (space counts as keystroke)
      var typedWords = wordsOf(typedRaw);
      var spans = els.textDisplay.querySelectorAll('span');

      var full=0, partial=0;
      for (var n=0;n<spans.length;n++){ spans[n].classList.remove('ok','err','cur'); }

      for (var i=0;i<refWords.length;i++){
        var span = spans[i];
        var tw = typedWords[i];
        if (tw==null){ continue; }              // omissions counted later as full errors
        if (tw === refWords[i]) span.classList.add('ok');
        else { span.classList.add('err'); partial++; }
      }
      if (typedWords.length < refWords.length){ full = refWords.length - typedWords.length; }     // omissions = full
      if (typedWords.length > refWords.length){ partial += (typedWords.length - refWords.length); } // extras = partial

      var curIndex = Math.max(0, typedWords.length - 1);
      var curSpan = spans[curIndex]; if (curSpan){ curSpan.classList.add('cur'); curSpan.scrollIntoView({block:'nearest', inline:'nearest'}); }

      var keystrokes = typedRaw.length;     // every char incl. spaces
      var grossWords = keystrokes / 5;      // 5 keystrokes = 1 word
      var grossWPM = grossWords / minutes;

      var totalErrors = full + partial;
      var grace = 5;
      var extraErrors = Math.max(0, totalErrors - grace);
      var penaltyWords = extraErrors * 5;   // −5 correct words per extra mistake
      var netWords = Math.max(0, grossWords - penaltyWords);
      var netWPM = netWords / minutes;

      var minSpeed = stage === 'HI' ? 25 : 30;
      var passed = netWPM >= minSpeed;

      if (stage==='EN'){
        els.grossEN.innerHTML=grossWPM.toFixed(2)+'<span class="u"> WPM</span>';
        els.netEN.innerHTML=netWPM.toFixed(2)+'<span class="u"> WPM</span>';
        els.fullEN.textContent=full; els.partialEN.textContent=partial;
        els.penaltyEN.innerHTML=penaltyWords+'<span class="u"> Words</span>';
        els.badgeEN.className = passed ? 'pill-pass' : 'pill-fail';
        els.badgeEN.textContent = 'EN: ' + (passed ? 'PASS' : 'FAIL');
        els.bothResults.classList.remove('hidden'); els.preResultsNote.classList.add('hidden');
      } else {
        els.grossHI.innerHTML=grossWPM.toFixed(2)+'<span class="u"> WPM</span>';
        els.netHI.innerHTML=netWPM.toFixed(2)+'<span class="u"> WPM</span>';
        els.fullHI.textContent=full; els.partialHI.textContent=partial;
        els.penaltyHI.innerHTML=penaltyWords+'<span class="u"> Words</span>';
        els.badgeHI.className = passed ? 'pill-pass' : 'pill-fail';
        els.badgeHI.textContent = 'HI: ' + (passed ? 'PASS' : 'FAIL');
        els.bothResults.classList.remove('hidden'); els.preResultsNote.classList.add('hidden');
      }

      return { grossWPM:grossWPM, netWPM:netWPM, fullErrors:full, partialErrors:partial, penaltyWords:penaltyWords, passed:passed };
    }

    function showCombinedResults(){
      var enPass = results.EN && results.EN.passed === true;
      var hiPass = results.HI && results.HI.passed === true;
      var overallPass = enPass && hiPass;
      els.badgeOverall.className = overallPass ? 'pill-pass' : 'pill-fail';
      els.badgeOverall.textContent = 'OVERALL: ' + (overallPass ? 'PASS' : 'FAIL');
    }

    function highlightProgress(){
      var refWords = passage.split(/\s+/);
      var typedWords = wordsOf(els.inputArea.value);
      var spans = els.textDisplay.querySelectorAll('span');
      for (var i=0;i<spans.length;i++){
        var span = spans[i]; span.classList.remove('ok','err','cur');
        var tw = typedWords[i]; if (tw==null) continue;
        if (tw === refWords[i]) span.classList.add('ok'); else span.classList.add('err');
      }
      var curIndex = Math.max(0, typedWords.length - 1);
      var curSpan = spans[curIndex]; if (curSpan){ curSpan.classList.add('cur'); curSpan.scrollIntoView({block:'nearest', inline:'nearest'}); }
    }

    /* ===== Backspace/Delete/Cut: ONLY within last TWO spaces of typed text ===== */
    function allowedBackspaceMinBySpaces(val){
      // Collect indices of every space in current typed text
      var spaces = [];
      for (var i=0;i<val.length;i++){ if (val[i] === ' ') spaces.push(i); }
      if (spaces.length <= 2) return 0;                 // if <=2 spaces typed, allow from start
      return spaces[spaces.length - 3] + 1;             // lock everything before the 3rd-from-last space
    }

    /* ===== Global Ctrl/Cmd/Refresh toast ===== */
    window.addEventListener('keydown', function(e){
      if (!started) return;
      // Block refresh keys
      if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 'r'))){
        showToast('⚠️ CTRL/CMD or Paste not allowed');
        e.preventDefault();
      }
    });

    /* ===== BEFOREINPUT: block paste & deletion beyond boundary ===== */
    els.inputArea.addEventListener('beforeinput', function(e){
      if (!started) return;
      var type = e.inputType;

      // Any paste/drop
      if (type === 'insertFromPaste' || type === 'insertFromDrop'){
        showToast('⚠️ CTRL/CMD or Paste not allowed');
        e.preventDefault(); return;
      }

      // Deletions (backspace, delete, cut)
      if (type === 'deleteContentBackward' || type === 'deleteContentForward' || type === 'deleteByCut'){
        var text = e.target.value;
        var selStart = e.target.selectionStart;
        var minIdx = allowedBackspaceMinBySpaces(text);
        if (selStart <= minIdx){ e.preventDefault(); return; }
      }
    });

    /* ===== Keydown fallback ===== */
    els.inputArea.addEventListener('keydown', function(e){
      if (!started) return;

      // Ctrl/Cmd-anything
      if (e.ctrlKey || e.metaKey){
        if (e.key !== 'Control' && e.key !== 'Meta'){ showToast('⚠️ CTRL/CMD or Paste not allowed'); }
        e.preventDefault(); return;
      }
      // Shift+Insert paste
      if (e.shiftKey && e.key === 'Insert'){
        showToast('⚠️ CTRL/CMD or Paste not allowed');
        e.preventDefault(); return;
      }

      // Prevent space after typed words reach passage word count (spec)
      if (e.key === ' '){
        var refCount = passage.split(/\s+/).length;
        var typedCount = (els.inputArea.value.trim().length ? els.inputArea.value.trim().split(/\s+/).length : 0);
        if (typedCount >= refCount){ e.preventDefault(); return; }
      }

      // Backspace/Delete boundary across selection
      if (e.key === 'Backspace' || e.key === 'Delete'){
        var text  = els.inputArea.value;
        var start = els.inputArea.selectionStart;
        var end   = els.inputArea.selectionEnd;
        var minIdx = allowedBackspaceMinBySpaces(text);
        var leftMost = Math.min(start, end);
        if (leftMost <= minIdx){ e.preventDefault(); return; }
      }
    }); }
        e.preventDefault(); return;
      }
      // Shift+Insert paste
      if (e.shiftKey && e.key === 'Insert'){
        showToast('⚠️ CTRL/CMD or Paste not allowed');
        e.preventDefault(); return;
      }
      // Backspace/Delete fallback
      if (e.key === 'Backspace' || e.key === 'Delete'){
        var text  = e.target.value;
        var start = e.target.selectionStart;
        var minIdx = allowedBackspaceMinBySpaces(text);
        if (start <= minIdx){ e.preventDefault(); return; }
      }
    });

    // Mouse/context paste fallback
    els.inputArea.addEventListener('paste', function(e){
      showToast('⚠️ CTRL/CMD or Paste not allowed');
      e.preventDefault();
    });

    els.inputArea.addEventListener('input', function(){ if (!started) return; highlightProgress(); });

    // Prevent unload/refresh during test
    window.addEventListener('beforeunload', function(e){ if (!started) return; e.preventDefault(); e.returnValue=''; });

    // Buttons
    els.startBtn.addEventListener('click', function(){
      if (els.startBtn.textContent==='Restart'){ resetAll(); return; }
      startStage();
    });
    els.submitBtn.addEventListener('click', function(){
      if (intervalId) clearInterval(intervalId); intervalId=null; finishStage();
    });
    els.resetBtn.addEventListener('click', resetAll);
    els.hindiFont.addEventListener('change', setFonts);
    els.passageSet.addEventListener('change', function(){ if (started) return; applySet(els.passageSet.value); });

    // Init UI
    loadPassages();
    resetAll();
  });
  </script>
</body>
</html>
